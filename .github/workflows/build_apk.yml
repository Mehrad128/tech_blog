name: Build Flutter APK (Debug)

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-apk:
    name: Build Debug APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          channel: 'stable'
          cache: true
          
      - name: Verify Flutter version
        run: flutter --version
      
      - name: Find Flutter project root
        id: find-project
        run: |
          # Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù…Ø³ÛŒØ± Ù¾Ø±ÙˆÚ˜Ù‡ ÙÙ„Ø§ØªØ± (Ø¬Ø§ÛŒÛŒ Ú©Ù‡ pubspec.yaml ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù‡)
          if [ -f "pubspec.yaml" ]; then
            echo "project_path=." >> $GITHUB_OUTPUT
            echo "âœ… Found pubspec.yaml in root directory"
          elif [ -f "my_flutter_app/pubspec.yaml" ]; then
            echo "project_path=my_flutter_app" >> $GITHUB_OUTPUT
            echo "âœ… Found pubspec.yaml in my_flutter_app directory"
          else
            # Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¹Ù…ÛŒÙ‚â€ŒØªØ± Ø¨Ø±Ø§ÛŒ pubspec.yaml
            PROJECT_PATH=$(find . -name "pubspec.yaml" -type f -exec dirname {} \; | head -n 1)
            if [ -n "$PROJECT_PATH" ]; then
              echo "project_path=$PROJECT_PATH" >> $GITHUB_OUTPUT
              echo "âœ… Found pubspec.yaml in $PROJECT_PATH"
            else
              echo "âŒ Could not find pubspec.yaml in any directory"
              exit 1
            fi
          fi
          
          echo "Current directory structure:"
          ls -la
      
      - name: Install dependencies
        working-directory: ${{ steps.find-project.outputs.project_path }}
        run: flutter pub get
        
      - name: Run code generation (if needed)
        working-directory: ${{ steps.find-project.outputs.project_path }}
        run: |
          if grep -q "build_runner" pubspec.yaml; then
            flutter pub run build_runner build --delete-conflicting-outputs
          else
            echo "build_runner not found in dependencies, skipping code generation"
          fi
        continue-on-error: true
        
      - name: Run tests
        working-directory: ${{ steps.find-project.outputs.project_path }}
        run: flutter test
        continue-on-error: true
        
      - name: Clean previous builds
        working-directory: ${{ steps.find-project.outputs.project_path }}
        run: flutter clean
        
      - name: Build debug APK
        working-directory: ${{ steps.find-project.outputs.project_path }}
        run: flutter build apk --debug
        
      - name: Build split APKs (per ABI)
        working-directory: ${{ steps.find-project.outputs.project_path }}
        run: flutter build apk --debug --split-per-abi
        continue-on-error: true
        
      - name: List APK files
        working-directory: ${{ steps.find-project.outputs.project_path }}
        run: |
          echo "APK files found:"
          find . -name "*.apk" -type f | while read -r file; do
            size=$(du -h "$file" | cut -f1)
            echo "  - $file ($size)"
          done
          
      - name: Upload debug APK (universal)
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-universal
          path: ${{ steps.find-project.outputs.project_path }}/build/app/outputs/flutter-apk/app-debug.apk
          if-no-files-found: warn
          retention-days: 7
          
      - name: Upload split APKs
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-split
          path: |
            ${{ steps.find-project.outputs.project_path }}/build/app/outputs/flutter-apk/app-*-debug.apk
            !${{ steps.find-project.outputs.project_path }}/build/app/outputs/flutter-apk/app-debug.apk
          if-no-files-found: ignore
          retention-days: 7
          
      - name: Create summary
        working-directory: ${{ steps.find-project.outputs.project_path }}
        run: |
          echo "## âœ… Build Completed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± APK Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
            size=$(du -h "build/app/outputs/flutter-apk/app-debug.apk" | cut -f1)
            echo "| Universal APK | $size |" >> $GITHUB_STEP_SUMMARY
          fi
          
          for apk in build/app/outputs/flutter-apk/app-*-debug.apk; do
            if [ -f "$apk" ] && [[ ! "$apk" == *"app-debug.apk" ]]; then
              filename=$(basename "$apk")
              size=$(du -h "$apk" | cut -f1)
              echo "| $filename | $size |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”½ APK files are available as artifacts (download from the Summary page)" >> $GITHUB_STEP_SUMMARY