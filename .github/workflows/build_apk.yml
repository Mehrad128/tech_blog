name: Build Flutter APK (Debug)

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-apk:
    name: Build Debug APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          channel: 'stable'
          cache: true
      
      - name: Navigate to project and cleanup
        working-directory: ./tech_blog
        run: |
          echo "ðŸ“ Current directory: $(pwd)"
          echo "ðŸ“‚ Listing files:"
          ls -la
          
          # Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø§Ø² pubspec.yaml Ùˆ Ù¾ÙˆØ´Ù‡ lib
          cp pubspec.yaml pubspec.yaml.backup
          if [ -d "lib" ]; then
            cp -r lib lib_backup
          fi
          if [ -d "assets" ]; then
            cp -r assets assets_backup
          fi
      
      - name: Complete regeneration of Android project
        working-directory: ./tech_blog
        run: |
          echo "ðŸ”„ Completely regenerating Android project..."
          
          # Ø­Ø°Ù Ú©Ø§Ù…Ù„ Ù¾ÙˆØ´Ù‡ android
          rm -rf android/
          rm -rf .dart_tool/
          rm -rf build/
          
          # Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡ Ø§Ø² ØµÙØ±
          flutter create --platforms=android --project-name=tech_blog .
          
          # Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù…
          if [ -f "pubspec.yaml.backup" ]; then
            # Ø§Ø¯ØºØ§Ù… dependencies Ø§Ø² ÙØ§ÛŒÙ„ backup
            grep -A 100 "dependencies:" pubspec.yaml.backup > temp_deps.txt
            echo "âœ… Dependencies backed up"
          fi
          
          # Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§
          if [ -d "lib_backup" ]; then
            rm -rf lib
            mv lib_backup lib
          fi
          
          if [ -d "assets_backup" ]; then
            mv assets_backup assets
          fi
          
          echo "âœ… Android project regenerated"
      
      - name: Create local.properties
        working-directory: ./tech_blog/android
        run: |
          echo "Creating local.properties..."
          echo "sdk.dir=/usr/lib/android-sdk" > local.properties
          echo "flutter.sdk=$FLUTTER_ROOT" >> local.properties
          
          # Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù…Ø³ÛŒØ± Flutter SDK
          FLUTTER_PATH=$(which flutter)
          FLUTTER_DIR=$(dirname $(dirname $FLUTTER_PATH))
          echo "flutter.sdk=$FLUTTER_DIR" >> local.properties
          
          echo "âœ… local.properties created:"
          cat local.properties
      
      - name: Get packages
        working-directory: ./tech_blog
        run: flutter pub get
        
      - name: Build debug APK
        working-directory: ./tech_blog
        run: flutter build apk --debug
        
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: tech-blog-debug-apk
          path: tech_blog/build/app/outputs/flutter-apk/app-debug.apk
          if-no-files-found: error
          retention-days: 7